$.mobile.loading('show', {
    text: 'Loading Ustad Mobile',
    textVisible: true,
    theme: 'b',
    html: ""});
var USTADDEBUGMODE = 1;
var username="";
var password="";
function debugLog(msg) {
    if(USTADDEBUGMODE == 1) {
        console.log(msg);
    }
}

function fail(evt) {
    alert("something went wrong: " + evt.target.error.code);
    console.log(evt.target.error.code);
	debugLog("Something went wrong");
}

// Wait for PhoneGap to load
//
function onLoad() {
    $.mobile.loading('show', {
    text: 'Loading Ustad Mobile',
    textVisible: true,
    theme: 'b',
    html: ""});
    document.addEventListener("deviceready", onDeviceReady, false);
}

// PhoneGap is ready
//
function onDeviceReady() {
    checkLoggedIn();
}

//The form in html calls this with the values. We seperate the form arguments with actual function of login for
//testing and code-reuse purposes.
function umloginFromForm() {
    username = $("#username").val();
    password = $("#password").val();
    
    console.log("User name and password is: " + username + " / " + password);
    if (!url){
    var url = 'http://intranet.paiwastoon.net/umcloud/app/login.xhtml';
    }
    umlogin(username, password, url, umloginredirect);
}

function umloginredirect(statuscode) {
    console.log("Status code is: " + statuscode);
    if(statuscode == 200) {
        localStorage.setItem('username',username);
        localStorage.setItem('password',password);
        openPage("ustadmobile_booklist.html");
    }else {
        alert("Wrong username/password combination, or Please check that you are able to connect to the internet and your server.");
    }
}

//This function will get called when umlogin proceeds with success or error. The arg is the statusCode that will get 
//passed to the 
function runcallback(callbackfunction, arg) {
    if (callbackfunction != null && typeof callbackfunction === "function") {
        console.log("Within the call back function with arg: " + arg );
        callbackfunction(arg);
    }
}

/*
This function logs the user to the specified server and credentials. Initially, server being UmCloud(Toughra). This uses Ajax to authenticate.
*/
function umlogin(username, password, url, callback){

    var param = 'userid=' + username + '&password=' + password;
    //var url = 'http://intranet.paiwastoon.net/umcloud/app/login.xhtml';
    $.ajax({
        url: url,  
        type: 'POST',        
        data: param,
        datatype: 'text',
        success: function(data, textStatus, jqxhr){
            debugLog("Logging to server: " + url + " a success with code:" + jqxhr.status);
            runcallback(callback, jqxhr.status);
            },
        complete: function (jqxhr, txt_status) {
            debugLog("Ajax call completed to server. Status: " + jqxhr.status);
            },
        error: function (jqxhr,b,c){
        
            alert("Wrong username/password combination or server error. Status Code:" + jqxhr.status);
            console.log("Wrong username/password combination or server error. Status Code:" + jqxhr.status);
            runcallback(callback, jqxhr.status);
            },
        statusCode: {
            200: function(){
                //alert("Login success on the server!");
                console.log("Login success on the server with statusCode 200.");
                localStorage.setItem('username',username);
                localStorage.setItem('password',password);
                },
            0: function(){
                console.log("Status code 0, unable to connect to server or no internet/intranet access");
                    }
                    }
            
        });
    
}

/*
Checks if user logged in from earlier and re directs to book list.
*/
function checkLoggedIn(){

    if (localStorage.getItem('username')){
        openPage("ustadmobile_booklist.html");
        //set homepage as booklist and not Login.
    }
    $.mobile.loading('hide');
}

/*
Skips if user doesn't want to log in but still access Books.
*/
function umSkip(){
    localStorage.removeItem('username');
    openPage("ustadmobile_booklist.html");
}

/*
Simple Open page wrapper
*/
function openPage(openFile){
    console.log("Going to page: " + openFile);
	window.open(openFile).trigger("create");
}

